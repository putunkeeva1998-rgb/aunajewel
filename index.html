<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AUNA jewel</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #1a1a1a; --bg: #ffffff; --card-bg: #f9f9f9; --gray: #eeeeee; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: #000; padding-bottom: 80px; }
        [v-cloak] { display: none; }
        
        .header { padding: 15px; text-align: center; border-bottom: 1px solid var(--gray); position: sticky; top: 0; background: #fff; z-index: 1000; }
        .header h1 { margin: 0; font-size: 14px; letter-spacing: 3px; text-transform: uppercase; font-weight: 800; }
        .catalog-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: var(--card-bg); border-radius: 15px; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #fff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--gray); z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #999; }
        .tab-item.active { color: var(--accent); }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 4px; }

        .btn-black { background: #000; color: #fff; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .admin-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; }
        #map { width: 100%; height: 200px; border-radius: 15px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="header">
        <h1>AUNA jewel</h1>
    </div>

    <div v-if="activeTab === 'catalog'">
        <div class="catalog-grid">
            <div v-for="p in products" :key="p.id" class="card" v-if="!p.hidden">
                <img :src="p.images ? p.images[0] : ''" @click="openProduct(p)">
                <div style="padding: 10px;">
                    <div style="font-size: 13px; font-weight: 600;">{{p.name}}</div>
                    <div style="font-weight: 800; margin-top: 5px;">{{p.price}} ₽</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="activeTab === 'profile'" style="padding: 15px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <h3>{{user.first_name}}</h3>
            <button @click="tg.openTelegramLink('https://t.me/opttania')" class="btn-black" style="background:#eee; color:#000;">Поддержка</button>
        </div>

        <div v-if="isAdmin" style="border: 1px dashed #000; padding: 15px; border-radius: 15px;">
            <h3>Админ-панель</h3>
            <input v-model="newItem.name" placeholder="Название" class="admin-input">
            <input v-model="newItem.price" placeholder="Цена" class="admin-input">
            <input type="file" @change="uploadPhoto">
            <button @click="saveProduct" class="btn-black" style="margin-top:10px;">Добавить товар</button>
        </div>
    </div>

    <nav class="tab-bar">
        <div @click="activeTab = 'catalog'" :class="['tab-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Каталог</span>
        </div>
        <div @click="activeTab = 'profile'" :class="['tab-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
            <span>Профиль</span>
        </div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw", 
        authDomain: "auna-jewel.firebaseapp.com", 
        projectId: "auna-jewel" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const { createApp } = Vue;
    const tg = window.Telegram.WebApp;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                isAdmin: false,
                adminId: 5886656847,
                user: { first_name: 'Гость' },
                products: [],
                newItem: { name: '', price: '', images: [] }
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            async uploadPhoto(e) {
                const file = e.target.files[0];
                const form = new FormData();
                form.append('image', file);
                const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: form });
                const data = await res.json();
                this.newItem.images.push(data.data.url);
                tg.showAlert('Фото загружено!');
            },
            async saveProduct() {
                await addDoc(collection(db, "products"), { ...this.newItem, hidden: false, createdAt: Date.now() });
                tg.showAlert('Товар добавлен!');
                this.newItem = { name: '', price: '', images: [] };
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            if(tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                if(Number(this.user.id) === this.adminId) this.isAdmin = true;
            }

            // Загрузка товаров
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            onSnapshot(q, (sn) => {
                this.products = sn.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }
    }).mount('#app');
</script>
</body>
</html>
