<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AUNA jewel</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #000000; --bg: #ffffff; --card-bg: #f8f8f8; --gray: #eeeeee; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: #000; padding-bottom: 80px; }
        [v-cloak] { display: none; }
        
        /* Шапка */
        .header { padding: 15px; text-align: center; border-bottom: 1px solid var(--gray); position: sticky; top: 0; background: #fff; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 14px; letter-spacing: 3px; text-transform: uppercase; font-weight: 800; }

        /* Каталог 2 ряда */
        .catalog-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        
        /* Иконка сердца (прозрачная) */
        .fav-icon { position: absolute; top: 10px; right: 10px; font-size: 22px; color: rgba(255,255,255,0.7); cursor: pointer; transition: 0.2s; }
        .fav-icon.active { color: #ff4757; }

        /* Таб-бар */
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #fff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--gray); z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #999; }
        .tab-item.active { color: var(--accent); }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 4px; }

        /* Кнопки размеров */
        .size-btn { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fff; flex: 1; text-align: center; font-size: 12px; }
        .size-btn.active { background: #000; color: #fff; border-color: #000; }

        /* Модалка товара */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; overflow-y: auto; }
        .btn-main { background: #000; color: #fff; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: 700; font-size: 14px; margin-top: 10px; }
        
        /* Бургер */
        .burger-content { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; padding: 25px; }
        #map { width: 100%; height: 200px; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="header">
        <div @click="ui.burger = true; vbt()" style="font-size: 20px;">☰</div>
        <h1>AUNA jewel</h1>
        <div style="width:20px;"></div>
    </div>

    <div v-if="ui.burger" class="burger-content">
        <div @click="ui.burger = false; vbt()" style="font-size: 30px; margin-bottom: 20px;">✕</div>
        <div v-for="link in burgerLinks" @click="showInfo(link)" style="padding: 18px 0; border-bottom: 1px solid #eee; font-weight: 600;">{{ link.t }}</div>
    </div>

    <div v-if="at === 'catalog'">
        <div style="display: flex; gap: 8px; padding: 10px; overflow-x: auto;">
            <button v-for="cat in ['Все', 'Серьги', 'Цепочки']" @click="ui.cat = cat; vbt()" :class="['size-btn', ui.cat === cat ? 'active' : '']">{{cat}}</button>
        </div>
        <div class="catalog-grid">
            <div v-for="p in filteredProducts" :key="p.id" class="card" v-if="!p.hidden" @click="openP(p)">
                <img :src="p.images[0]">
                <div class="fav-icon" :class="{active: isFav(p)}" @click.stop="toggleFav(p)">❤</div>
                <div style="padding: 10px;">
                    <div style="font-size: 13px; font-weight: 600;">{{p.name}}</div>
                    <div style="font-weight: 800; margin-top: 4px;">{{p.price}} ₽</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="at === 'fav'" style="padding: 10px;">
        <h2 style="padding-left: 10px;">Избранное</h2>
        <div class="catalog-grid" v-if="favs.length">
            <div v-for="p in favs" class="card" @click="openP(p)">
                <img :src="p.images[0]">
                <div style="padding: 10px;">
                    <div style="font-size: 13px;">{{p.name}} ({{p.selS}})</div>
                    <div style="font-weight: 800;">{{p.price}} ₽</div>
                </div>
            </div>
        </div>
        <div v-else style="text-align: center; color: #999; margin-top: 50px;">Здесь пока пусто</div>
    </div>

    <div v-show="at === 'cart'" style="padding: 15px;">
        <h2>Корзина</h2>
        <div v-for="(item, idx) in cart" style="display: flex; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 10px;">
            <img :src="item.images[0]" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
            <div style="flex: 1;">
                <div style="font-weight: 600;">{{item.name}}</div>
                <div style="font-size: 12px; color: #666;">Размер: {{item.selS}}</div>
                <div style="font-weight: 800;">{{item.price}} ₽</div>
            </div>
            <div @click="cart.splice(idx, 1); vbt()" style="color: #ff4757;">✕</div>
        </div>
        
        <div v-if="cart.length" style="margin-top: 20px;">
            <input v-model="form.phone" placeholder="Номер телефона (10-11 цифр)" type="tel" class="size-btn" style="width: 100%; text-align: left; margin-bottom: 10px;">
            <p>Доставка:</p>
            <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                <button v-for="m in ['СДЭК', 'Почта', '5post']" @click="form.m = m; vbt(); initMap()" :class="['size-btn', form.m === m ? 'active' : '']">{{m}}</button>
            </div>
            <div id="map"></div>
            <button class="btn-main" @click="checkout">ОФОРМИТЬ ЗАКАЗ</button>
        </div>
    </div>

    <div v-if="at === 'profile'" style="padding: 15px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <img :src="user.photo" style="width: 80px; height: 80px; border-radius: 50%; background: #eee;">
            <h3>{{user.first_name}}</h3>
            <button @click="tg.openTelegramLink('https://t.me/opttania'); vbt()" class="btn-main" style="background: #f0f0f0; color: #000;">Написать в поддержку</button>
        </div>

        <div v-if="isAdmin" style="border: 1px dashed #000; padding: 15px; border-radius: 15px; background: #fff;">
            <h3>Админ-панель</h3>
            <input v-model="newItem.name" placeholder="Название" class="size-btn" style="width:100%; margin-bottom:8px; text-align:left;">
            <input v-model="newItem.price" placeholder="Цена" class="size-btn" style="width:100%; margin-bottom:8px; text-align:left;">
            <textarea v-model="newItem.desc" placeholder="Описание" class="size-btn" style="width:100%; margin-bottom:8px; text-align:left; height: 80px;"></textarea>
            <input v-model="newItem.sizes" placeholder="Размеры (через запятую)" class="size-btn" style="width:100%; margin-bottom:8px; text-align:left;">
            <select v-model="newItem.category" class="size-btn" style="width:100%; margin-bottom:8px; text-align:left;">
                <option>Серьги</option>
                <option>Цепочки</option>
            </select>
            <input type="file" @change="uploadImg" style="margin-bottom: 10px;">
            <button class="btn-main" @click="saveP">ДОБАВИТЬ ТОВАР</button>

            <h4 style="margin-top: 20px;">Управление:</h4>
            <div v-for="p in products" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 12px;">{{p.name}}</span>
                <button @click="toggleH(p); vbt()" :style="{background: p.hidden ? '#ff4757' : '#2ed573'}" style="color:#fff; border:none; padding:5px 10px; border-radius:5px; font-size:10px;">{{p.hidden ? 'СКРЫТ' : 'ВИДЕН'}}</button>
            </div>
        </div>
    </div>

    <div v-if="sp" class="modal">
        <div @click="sp = null; vbt()" style="padding: 15px; font-size: 25px;">✕</div>
        <div style="position: relative;">
            <img :src="sp.images[curImg]" style="width: 100%; height: 350px; object-fit: cover;">
            <div v-if="sp.images.length > 1" style="display: flex; justify-content: center; gap: 5px; margin-top: 10px;">
                <div v-for="(img, i) in sp.images" @click="curImg = i" :style="{background: curImg === i ? '#000' : '#ccc'}" style="width:8px; height:8px; border-radius:50%;"></div>
            </div>
        </div>
        <div style="padding: 20px;">
            <h1>{{sp.name}}</h1>
            <div style="font-size: 22px; font-weight: 800;">{{sp.price}} ₽</div>
            <p style="color: #666; margin: 15px 0;">{{sp.desc}}</p>
            <p>Выберите размер:</p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button v-for="s in sp.sizes" @click="selS = s; vbt()" :class="['size-btn', selS === s ? 'active' : '']">{{s}}</button>
            </div>
            <button class="btn-main" @click="addCart(sp)">ДОБАВИТЬ В КОРЗИНУ</button>
        </div>
    </div>

    <nav class="tab-bar">
        <div v-for="t in tabs" @click="at = t.id; vbt(); if(t.id==='cart')initMap()" :class="['tab-item', at === t.id ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="currentColor" v-html="t.icon"></svg>
            <span>{{t.l}}</span>
        </div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const fbc = { 
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw", 
        authDomain: "auna-jewel.firebaseapp.com", 
        projectId: "auna-jewel" 
    };
    const app = initializeApp(fbc);
    const db = getFirestore(app);

    const tg = window.Telegram.WebApp;
    Vue.createApp({
        data() {
            return {
                at: 'catalog', isAdmin: false, adminId: 387881523,
                user: { first_name: 'Гость', photo: '' },
                products: [], 
                cart: JSON.parse(localStorage.getItem('auna_cart') || '[]'),
                favs: JSON.parse(localStorage.getItem('auna_favs') || '[]'),
                sp: null, selS: '', curImg: 0,
                ui: { burger: false, cat: 'Все' },
                form: { phone: '', m: 'СДЭК', name: '' },
                newItem: { name: '', price: '', desc: '', images: [], category: 'Серьги', sizes: '16,17,18' },
                burgerLinks: [
                    { t: 'О НАС', m: 'Бренд AUNA jewel создан для ценителей изящных форм.' },
                    { t: 'ВОЗВРАТ', m: 'Возврат возможен в течение 14 дней.' },
                    { t: 'ДОСТАВКА', m: 'Доставка по РФ: СДЭК, Почта, 5post.' }
                ],
                tabs: [
                    { id: 'catalog', l: 'Каталог', icon: '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>' },
                    { id: 'fav', l: 'Избранное', icon: '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>' },
                    { id: 'cart', l: 'Корзина', icon: '<path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>' },
                    { id: 'profile', l: 'Профиль', icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/>' }
                ]
            }
        },
        computed: {
            filteredProducts() {
                if (this.ui.cat === 'Все') return this.products;
                return this.products.filter(p => p.category === this.ui.cat);
            }
        },
        methods: {
            vbt() { tg.HapticFeedback.impactOccurred('medium'); },
            showInfo(l) { tg.showPopup({ title: l.t, message: l.m }); this.vbt(); },
            async uploadImg(e) {
                const f = e.target.files[0];
                const fd = new FormData(); fd.append('image', f);
                const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                const d = await res.json();
                this.newItem.images.push(d.data.url);
                tg.showAlert('Фото загружено!');
            },
            async saveP() {
                const sizes = this.newItem.sizes.split(',').map(s => s.trim());
                await addDoc(collection(db, "products"), { ...this.newItem, sizes, hidden: false, createdAt: Date.now() });
                tg.showAlert('Добавлено!');
                this.newItem = { name: '', price: '', desc: '', images: [], category: 'Серьги', sizes: '16,17,18' };
            },
            async toggleH(p) { await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden }); },
            openP(p) { this.vbt(); this.sp = p; this.selS = p.sizes[0]; this.curImg = 0; },
            isFav(p) { return this.favs.some(f => f.id === p.id); },
            toggleFav(p) {
                this.vbt();
                const idx = this.favs.findIndex(f => f.id === p.id);
                if (idx > -1) this.favs.splice(idx, 1);
                else this.favs.push({...p, selS: this.selS || p.sizes[0]});
                localStorage.setItem('auna_favs', JSON.stringify(this.favs));
            },
            addCart(p) {
                this.vbt();
                this.cart.push({...p, selS: this.selS});
                localStorage.setItem('auna_cart', JSON.stringify(this.cart));
                tg.showAlert('В корзине!');
                this.sp = null;
            },
            checkout() {
                const phone = this.form.phone.replace(/\D/g, '');
                if (phone.length < 10 || phone.length > 11) return tg.showAlert('Номер телефона должен быть 10-11 цифр!');
                this.vbt();
                const text = `ЗАКАЗ AUNA:\n${this.cart.map(i => i.name + ' (' + i.selS + ')').join(', ')}\n\nТЕЛ: ${this.form.phone}\nДОСТАВКА: ${this.form.m}`;
                tg.sendData(text);
                this.cart = []; localStorage.removeItem('auna_cart');
                tg.close();
            },
            initMap() {
                setTimeout(() => {
                    const m = new mapgl.Map('map', { center: [104.28, 52.28], zoom: 12, key: 'cab82c94-e619-42eb-9814-3361712feaf0' });
                    navigator.geolocation.getCurrentPosition(p => m.setCenter([p.coords.longitude, p.coords.latitude]));
                }, 100);
            }
        },
        mounted() {
            tg.ready(); tg.expand();
            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                this.user = { first_name: u.first_name, photo: u.photo_url || '' };
                this.form.name = u.first_name;
                if (Number(u.id) === this.adminId) this.isAdmin = true;
            }
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (sn) => {
                this.products = sn.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }
    }).mount('#app');
</script>
</body>
</html>
